name: Release

on:
  push:
    branches: [main]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'index.html'
      - 'package.json'
      - 'bun.lock'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/release.yml'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Configure FontAwesome registry
        run: |
          echo '@fortawesome:registry=https://npm.fontawesome.com/' >> .npmrc
          echo '//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_NPM_TOKEN }}' >> .npmrc
      - run: bun install
      - run: bun run check
      - run: bunx tsc --noEmit
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev
      - run: cd src-tauri && cargo fmt --check
      - run: cd src-tauri && cargo clippy -- -D warnings

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Configure FontAwesome registry
        run: |
          echo '@fortawesome:registry=https://npm.fontawesome.com/' >> .npmrc
          echo '//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_NPM_TOKEN }}' >> .npmrc
      - run: bun install
      - run: bun run test
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev
      - run: cd src-tauri && cargo test

  version:
    needs: [lint, test]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Resolve version
        id: resolve
        run: |
          cargo_version=$(grep '^version' src-tauri/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')

          if git rev-parse "v${cargo_version}" >/dev/null 2>&1; then
            major=$(echo "$cargo_version" | cut -d. -f1)
            minor=$(echo "$cargo_version" | cut -d. -f2)
            highest_patch=$(git tag --list "v${major}.${minor}.*" | sed "s/v${major}\.${minor}\.//" | sort -n | tail -1)
            if [ -z "$highest_patch" ]; then
              highest_patch=0
            fi
            next_patch=$((highest_patch + 1))
            version="${major}.${minor}.${next_patch}"
          else
            version="$cargo_version"
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"
          echo "Releasing v$version"

  build:
    needs: version
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bundles: deb,appimage
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: msi,nsis
          - os: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Configure FontAwesome registry
        shell: bash
        run: |
          echo '@fortawesome:registry=https://npm.fontawesome.com/' >> .npmrc
          echo '//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_NPM_TOKEN }}' >> .npmrc
      - run: bun install
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
          workspaces: src-tauri
      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev
      - name: Build Tauri app
        run: bunx tauri build --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}
      - name: Collect artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p artifacts
          cp src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb artifacts/ 2>/dev/null || true
          cp src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage artifacts/ 2>/dev/null || true
          cp src-tauri/target/${{ matrix.target }}/release/oulipoly-agent-runner artifacts/ 2>/dev/null || true
      - name: Collect artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p artifacts
          cp src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg artifacts/ 2>/dev/null || true
          cp src-tauri/target/${{ matrix.target }}/release/oulipoly-agent-runner artifacts/ 2>/dev/null || true
      - name: Collect artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi artifacts/ -ErrorAction SilentlyContinue
          Copy-Item src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe artifacts/ -ErrorAction SilentlyContinue
          Copy-Item src-tauri/target/${{ matrix.target }}/release/oulipoly-agent-runner.exe artifacts/ -ErrorAction SilentlyContinue
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: artifacts/*

  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: artifacts
      - name: Create tag
        run: |
          git tag ${{ needs.version.outputs.tag }}
          git push origin ${{ needs.version.outputs.tag }}
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          generate_release_notes: true
          files: artifacts/*
